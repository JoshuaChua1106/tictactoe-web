name: Deploy to AWS EC2

on:
  push:
    branches:
      - master

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-southeast-2

      - name: Get EC2 Instance ID
        id: get-instance
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=tictactoe-ec2" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Found instance: $INSTANCE_ID"

      - name: Wait for Systems Manager
        run: |
          echo "Waiting for SSM agent to be ready..."
          aws ssm wait instance-information-available \
            --filters "Key=InstanceIds,Values=${{ steps.get-instance.outputs.instance_id }}"

      - name: Deploy via Systems Manager
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.get-instance.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ec2-user",
              "if [ ! -d \"tictactoe-web\" ]; then git clone https://github.com/JoshuaChua1106/tictactoe-web.git; fi",
              "cd tictactoe-web",
              "git fetch origin",
              "git reset --hard origin/master",
              "docker compose down || true",
              "docker compose up -d --build",
              "echo Deployment complete!"
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"

          # Wait for command to complete
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.get-instance.outputs.instance_id }}"

          # Get command output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.get-instance.outputs.instance_id }}" \
            --query "StandardOutputContent" \
            --output text

      - name: Get deployment URL
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids "${{ steps.get-instance.outputs.instance_id }}" \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "ðŸš€ Deployment complete!"
          echo "App URL: http://$PUBLIC_IP"
